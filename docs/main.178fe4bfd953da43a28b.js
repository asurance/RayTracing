!function(t){var e={};function o(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=t,o.c=e,o.d=function(t,e,r){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(r,i,function(e){return t[e]}.bind(null,i));return r},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=3)}([function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(2),i=function(){function t(t,e,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===o&&(o=0),this.x=t,this.y=e,this.z=o}return t.prototype.reset=function(){return this.x=this.y=this.z=0,this},t.prototype.set=function(t,e,o){return this.x=t,this.y=e,this.z=o,this},t.prototype.clone=function(e){return void 0===e&&(e=t.Pool.create()),e.x=this.x,e.y=this.y,e.z=this.z,e},t.prototype.length=function(){return Math.hypot(this.x,this.y,this.z)},t.prototype.sqauredLength=function(){return this.dot(this)},t.prototype.normalize=function(e){void 0===e&&(e=t.Pool.create());var o=this.length();return o>0&&this.multiScale(1/o,e),e},t.prototype.add=function(e,o){return void 0===o&&(o=t.Pool.create()),o.x=this.x+e.x,o.y=this.y+e.y,o.z=this.z+e.z,o},t.prototype.multiScale=function(e,o){return void 0===o&&(o=t.Pool.create()),o.x=this.x*e,o.y=this.y*e,o.z=this.z*e,o},t.prototype.multiVec3=function(e,o){return void 0===o&&(o=t.Pool.create()),o.x=this.x*e.x,o.y=this.y*e.y,o.z=this.z*e.z,o},t.prototype.reciprocal=function(e){return void 0===e&&(e=t.Pool.create()),e.x=1/e.x,e.y=1/e.y,e.z=1/e.z,e},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.cross=function(e,o){void 0===o&&(o=t.Pool.create());var r=this.y*e.z-this.z*e.y,i=this.z*e.x-this.x*e.z,n=this.x*e.y-this.y*e.x;return o.x=r,o.y=i,o.z=n,o},t.prototype.reflect=function(e,o){var r=this;return void 0===o&&(o=t.Pool.create()),t.Pool.tidy((function(){return r.add(e.multiScale(-2*r.dot(e)))}),o)},t.prototype.refract=function(e,o){var r=this.normalize(),i=r.dot(e),n=1-o*o*(1-i*i);if(n>0){var c=t.Pool.tidy((function(){return r.add(e.multiScale(-i)).multiScale(o).add(e.multiScale(-Math.sqrt(n)))}));return t.Pool.reUse(r),c}return t.Pool.reUse(r),null},t.prototype.toString=function(){return"("+this.x+","+this.y+","+this.z+")"},t.Pool=new r.RecyclablePool(t,"Vector3"),t}();e.Vector3=i},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(0),i=o(2),n=function(){function t(t,e,o){void 0===t&&(t=r.Vector3.Pool.create()),void 0===e&&(e=r.Vector3.Pool.create()),void 0===o&&(o=0),this.depth=0,this.origin=t,this.direction=e,this.depth=o}return t.prototype.set=function(t,e,o){return void 0===o&&(o=0),this.origin=t,this.direction=e,this.depth=o,this},t.prototype.reset=function(){return this.origin.reset(),this.direction.reset(),this},t.prototype.clone=function(e){return void 0===e&&(e=t.Pool.create()),e.origin=this.origin.clone(e.origin),e.direction=this.direction.clone(e.direction),e},t.prototype.getPointAtT=function(t,e){var o=this;return void 0===e&&(e=r.Vector3.Pool.create()),r.Vector3.Pool.tidy((function(){return o.origin.add(o.direction.multiScale(t))}),e)},t.Pool=new i.RecyclablePool(t,"Ray"),t}();e.Ray=n},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){void 0===e&&(e=""),this.pool=[],this.tidyPool=[],this.tidyLayer=[],this.count=0,this.logCount="",this.template=t,this.logCount=e}return t.prototype.create=function(){var t=this.pool.pop();return t?t.reset():(t=new this.template,this.logCount&&(this.count++,console.log(this.logCount+":"+this.count))),this.tidyLayer.length>0&&this.tidyPool.push(t),t},t.prototype.reUse=function(t){this.pool.push(t)},t.prototype.tidy=function(t,e){var o;void 0===e&&(e=this.create()),this.tidyLayer.push(this.tidyPool.length),e=t().clone(e);var r=this.tidyLayer.pop();return(o=this.pool).push.apply(o,this.tidyPool.splice(r)),e},t}();e.RecyclablePool=r},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(4),i=o(6),n=o(0),c=o(7),u=o(8),a=o(9),l=o(10),s=o(11),d=o(12),h=document.createElement("canvas");h.width=s.WIDTH,h.height=s.HEIGHT,document.body.appendChild(h);var f=h.getContext("2d"),p=Math.cos(Math.PI/4),y=new c.World([new u.RTObject(new i.Sphere(n.Vector3.Pool.create().set(p,p/2,-1),p/2),new l.Reflect),new u.RTObject(new i.Sphere(n.Vector3.Pool.create().set(-p,p/2,-1),p/2),new l.Reflect),new u.RTObject(new i.Sphere(n.Vector3.Pool.create().set(0,-p,-1),p/2),new d.Dielectrics(1.5)),new u.RTObject(new i.Sphere(n.Vector3.Pool.create().set(0,0,-1-p),p/2),new a.Normal)]),P=new r.Camera(n.Vector3.Pool.create().set(0,0,0),n.Vector3.Pool.create().set(0,0,-1),n.Vector3.Pool.create().set(0,1,0),90,s.WIDTH,s.HEIGHT);console.log("first render"),P.render(y),f.putImageData(P.imageData,0,0)},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(0),i=o(1),n=o(5),c=function(){function t(t,e,o,i,n,c){var u=this;this.origin=t,this.width=n,this.height=c,this.imageData=new ImageData(n,c);var a=i*Math.PI/180,l=Math.tan(a/2),s=n/c*l,d=r.Vector3.Pool.tidy((function(){return t.add(e.multiScale(-1)).normalize()})),h=r.Vector3.Pool.tidy((function(){return o.cross(d).normalize()})),f=d.cross(h);this.lowerLeftCorner=r.Vector3.Pool.tidy((function(){return u.origin.add(h.multiScale(s).add(f.multiScale(l)).add(d).multiScale(-1))})),this.horizontal=h.multiScale(2*s),this.vertical=f.multiScale(2*l)}return t.prototype.render=function(t){var e=this,o={t:0,position:r.Vector3.Pool.create(),normal:r.Vector3.Pool.create()},c=i.Ray.Pool.create();c.origin=this.origin.clone(c.origin);for(var u=function(u){for(var l=function(l){r.Vector3.Pool.reUse(c.direction),c.direction=r.Vector3.Pool.tidy((function(){return e.lowerLeftCorner.add(e.horizontal.multiScale(u/(e.width-1)).add(e.vertical.multiScale(1-l/(e.height-1))))})),c.depth=0;for(var s=t.hitTest(c,o);s instanceof i.Ray;){if(s.depth>50){i.Ray.Pool.reUse(s),s=r.Vector3.Pool.create().set(0,0,0);break}var d=t.hitTest(s,o);i.Ray.Pool.reUse(s),s=d}n.render2Image(a.imageData,u,l,s),r.Vector3.Pool.reUse(s)},s=0;s<a.height;s++)l(s)},a=this,l=0;l<this.width;l++)u(l);i.Ray.Pool.reUse(c),r.Vector3.Pool.reUse(o.position),r.Vector3.Pool.reUse(o.normal)},t}();e.Camera=c},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.render2Image=function(t,e,o,r){var i=o*t.width+e<<2;t.data[i]=Math.floor(255.99*r.x),t.data[i+1]=Math.floor(255.99*r.y),t.data[i+2]=Math.floor(255.99*r.z),t.data[i+3]=255}},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(0),i=function(){function t(t,e){this.center=t.clone(),this.radius=e}return t.prototype.hitTest=function(t,e,o,i){var n=this,c=r.Vector3.Pool.tidy((function(){return t.origin.add(n.center.multiScale(-1))})),u=t.direction.sqauredLength(),a=c.dot(t.direction),l=c.sqauredLength()-this.radius*this.radius;if(r.Vector3.Pool.reUse(c),a*a-u*l){var s=Math.sqrt(a*a-u*l),d=(-a-s)/u;if(d<o&&d>e)return i.t=d,i.position=t.getPointAtT(d,i.position),i.normal=r.Vector3.Pool.tidy((function(){return i.position.add(n.center.multiScale(-1)).multiScale(1/n.radius)}),i.normal),!0;if((d=(-a+s)/u)<o&&d>e)return i.t=d,i.position=t.getPointAtT(d,i.position),i.normal=r.Vector3.Pool.tidy((function(){return i.position.add(n.center.multiScale(-1)).multiScale(1/n.radius)}),i.normal),!0}return!1},t}();e.Sphere=i},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(0),i=function(){function t(t){this.objs=t}return t.prototype.hitTest=function(t,e){var o=null,i=1/0;return this.objs.forEach((function(r,n){r.shape.hitTest(t,1e-10,i,e)&&(o=n,i=e.t)})),null!==o?this.objs[o].mat.scatter(t,e):r.Vector3.Pool.create().set((t.direction.y+2)/3,(t.direction.y+1)/2,(t.direction.y+3)/4)},t}();e.World=i},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e){this.shape=t,this.mat=e};e.RTObject=r},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){}return t.prototype.scatter=function(t,e){return e.normal.clone()},t}();e.Normal=r},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(1),i=o(0),n=function(){function t(){}return t.prototype.scatter=function(t,e){if(t.direction.dot(e.normal)>=0)return i.Vector3.Pool.create();var o=r.Ray.Pool.create();return o.set(e.position.clone(o.origin),i.Vector3.Pool.tidy((function(){return t.direction.normalize().reflect(e.normal)}),o.direction),t.depth+1),o},t}();e.Reflect=n},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WIDTH=577,e.HEIGHT=577},function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=o(0),i=o(1),n=function(){function t(t){this.n=t}return t.prototype.scatter=function(t,e){var o=r.Vector3.Pool.create(),n=this.n;t.direction.dot(e.normal)>0?o=e.normal.multiScale(-1,o):(o=e.normal.clone(o),n=1/n);var c=t.direction.refract(o,n);if(r.Vector3.Pool.reUse(o),c){var u=i.Ray.Pool.create();return u.set(e.position.clone(u.origin),c.clone(u.direction),t.depth+1),r.Vector3.Pool.reUse(c),u}var a=i.Ray.Pool.create();return a.set(e.position.clone(a.origin),r.Vector3.Pool.tidy((function(){return t.direction.reflect(e.normal)}),a.direction),t.depth+1),a},t}();e.Dielectrics=n}]);